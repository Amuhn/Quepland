@inject GameState  GameState
@inject MessageManager  MessageManager
@using System.Threading
@inject Blazored.LocalStorage.ISyncLocalStorageService localStorage
@implements IDisposable



@LoadNavbarTop()

@LoadNavbar()

@functions {
    bool collapseNavMenu = true;
    private Timer autoSaveTimer;
    private Area lastToggledArea;
    string autoSaveString = "Last autosave: Never";
    string test = "total";
    string NavMenuCssClass => collapseNavMenu ? "collapse" : null;

    private bool loadGameComplete;

    private string GetURL(string areaURL)
    {
        return "GatherMenu/" + areaURL;
    }
    void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }

    private RenderFragment LoadNavbarTop()
    {
        return builder =>
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(0, "class", "top-row pl-4 navbar navbar-dark");
            builder.OpenElement(1, "a");
            builder.AddAttribute(1, "class", "navbar-brand");
            builder.AddAttribute(1, "href", "");
            builder.AddContent(1, "Quepland Menu");
            builder.CloseElement();
            builder.OpenElement(1, "button");
            builder.AddAttribute(1, "class", "navbar-toggler");
            builder.AddAttribute(1, "onclick", () => ToggleNavMenu());
            builder.OpenElement(2, "span");
            builder.AddAttribute(2, "class", "navbar-toggler-icon");
            builder.CloseElement();
            builder.CloseElement();
            builder.CloseElement();
        };
    }

    private RenderFragment LoadNavbar()
    {
        return builder =>
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", NavMenuCssClass);
            builder.AddAttribute(2, "onclick", () => ToggleNavMenu());
            builder.OpenElement(3, "ul");
            builder.AddAttribute(4, "class", "nav flex-column");

            if (GameState.isHunting == false && GameState.isGathering == false && Program.areaManager != null)
            {
                //Make the bank link
                builder.OpenElement(5, "li");
                builder.AddAttribute(6, "class", "nav-item px-3");
                builder.OpenComponent<NavLink>(7);
                builder.AddAttribute(8, "class", "nav-link");
                builder.AddAttribute(9, "href", "/Bank");
                builder.AddAttribute(10, "ChildContent", (RenderFragment)((builder2) =>
                {
                    builder2.OpenElement(11, "span");
                    builder2.AddAttribute(12, "class", "oi oi-dollar");
                    builder2.AddAttribute(13, "aria-hidden", "true");
                    builder2.CloseElement();
                    builder2.AddContent(14, "Bank");
                }));
                builder.CloseComponent();
                builder.CloseElement();
                foreach (Area area in Program.areaManager.GetAreasWithChildren())
                {
                    if (area.IsUnlocked)
                    {
                        builder.AddContent(15, ParentButton(area));
                        foreach (string child in area.Children)
                        {
                            Area childArea = Program.areaManager.GetAreaByURL(child);
                            if (childArea.IsUnlocked && childArea.Hidden == false)
                            {
                                builder.AddContent(16, NavButton(childArea, false));
                            }
                        }
                    }
                }
            }
            builder.CloseElement();
            builder.CloseElement();
            if (loadGameComplete == false && GameState.saveDataLoaded == true)
            {
                HideAllChildren();
                loadGameComplete = true;
            }
        };
    }
    private RenderFragment NavButton(Area area, bool bold)
    {
        return builder =>
        {
            builder.OpenElement(0, "li");
            builder.AddAttribute(1, "class", "nav-item px-3");
            builder.OpenComponent<NavLink>(2);
            builder.AddAttribute(3, "class", "nav-link");

            if (area.ActionRequiredForAccess != null &&
                GameState.GetPlayer().HasItemToAccessArea(area.ActionRequiredForAccess) == false)
            {
                builder.AddAttribute(4, "href", "/GatherMenu/" + area.RedirectAreaURL);
                builder.AddAttribute(5, "onclick", () => MessageManager.AddMessage("You don't have the item to access this location.(" + area.ActionRequiredForAccess + ")", "red"));
                builder.AddAttribute(6, "title", "You do not have the item to access this location.(" + area.ActionRequiredForAccess + ")");
                builder.AddAttribute(7, "style", "background-color:#EC565650");
            }
            else
            {
                builder.AddAttribute(7, "href", "/GatherMenu/" + area.AreaURL);
            }

            builder.AddAttribute(12, "ChildContent", (RenderFragment)((builder2) =>
            {
                builder2.OpenElement(13, "span");
                builder2.AddAttribute(14, "class", area.Icon);
                builder2.AddAttribute(15, "aria-hidden", "true");
                builder2.CloseElement();
                builder2.OpenElement(16, "span");
                builder2.AddContent(18, area.Name);
                builder2.CloseElement();
                bool hasRoadblock = false;
                int numOfRoadblocks = 0;
                foreach (string a in area.UnlockableAreas ?? Enumerable.Empty<string>())
                {
                    if (Program.areaManager.GetAreaByName(a.Split(',')[0]).IsUnlocked == false)
                    {
                        hasRoadblock = true;
                        numOfRoadblocks++;
                    }
                }
                if (hasRoadblock)
                {
                    builder2.OpenElement(19, "div");
                    builder2.AddAttribute(20, "class", "badge badge-pill badge-success");
                    builder2.AddAttribute(21, "style", "margin-left:3px");
                    builder2.AddContent(22, "" + numOfRoadblocks);
                    builder2.CloseElement();
                }

            }));
            builder.CloseComponent();
            builder.CloseElement();
        };

    }
    private RenderFragment ParentButton(Area area)
    {
        return builder =>
        {
            builder.OpenElement(0, "li");
            builder.AddAttribute(1, "class", "nav-item px-3");

            builder.AddAttribute(2, "style", "background-color:#FFFFFF33; padding-top:10px; cursor:pointer");
            builder.AddAttribute(4, "onclick", () => ToggleAreaChildren(area));

            builder.OpenElement(5, "span");
            builder.AddAttribute(6, "class", area.Icon);
            builder.AddAttribute(7, "aria-hidden", "true");
            builder.AddAttribute(8, "style", "color:white");
            builder.CloseElement();
            builder.OpenElement(8, "span");

            builder.AddAttribute(9, "style", "font-size: large; font-weight: bold; color:white");
            builder.AddContent(12, area.Name);
            builder.CloseElement();


            builder.CloseElement();
        };

    }
    protected override void OnInit()
    {
        GameState.StateChanged += OnGameStateChanged;
        autoSaveTimer = new Timer(new TimerCallback(_ =>
        {
            AutoSave();

        }), null, 60000, 60000);
        this.StateHasChanged();
    }

    public void HideAllChildren()
    {
        foreach (Area area in Program.areaManager.GetAreasWithoutChildren())
        {
            area.Hidden = true;
        }
        StateHasChanged();
    }
    public void ToggleAreaChildren(Area area)
    {
        HideAllChildren();

        area.IsShowingChildren = !area.IsShowingChildren;
        foreach (string child in area.Children)
        {
            Program.areaManager.GetAreaByURL(child).Hidden = !Program.areaManager.GetAreaByURL(child).Hidden;
        }

        StateHasChanged();
    }

    private void AutoSave()
    {
        if (localStorage.GetItem<bool>("SaveGameExists") == false || GameState.saveDataLoaded == true)
        {
            localStorage.SetItem("Bank", GameState.GetPlayerBank().GetInventory().ToString());
            localStorage.SetItem("Skills", GameState.GetPlayer().GetSkillString());
            localStorage.SetItem("Inventory", GameState.GetPlayerInventory().ToString());
            localStorage.SetItem("Areas", Program.areaManager.SaveAreas());
            localStorage.SetItem("Followers", Program.followerManager.ToString());
            if(GameState.GetPlayer().activeFollower != null)
            {
                localStorage.SetItem("ActiveFollower", GameState.GetPlayer().activeFollower.id);
            }            
            localStorage.SetItem("AlchemyRecipes", GameState.GetPlayer().GetRecipes());
            localStorage.SetItem("SaveGameExists", true);
            autoSaveString = "Last autosave: " + DateTime.Now.ToShortTimeString();
            StateHasChanged();
        }
    }
    void IDisposable.Dispose()
    {
        GameState.StateChanged -= OnGameStateChanged;
    }

    void OnGameStateChanged(object sender, EventArgs e) => StateHasChanged();
}
