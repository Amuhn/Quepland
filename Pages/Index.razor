@page "/"
@inject HttpClient Http
@inject GameState GameState
@inject MessageManager MessageManager
@inject Blazored.LocalStorage.ISyncLocalStorageService localStorage
@implements IDisposable


<h1>Hello, Welcome to Quepland!</h1>
@if (debugMode)
{
    <p><button class="btn btn-primary" onclick="@(() => DebugAll99s())">Max Account</button></p>
    <p><button class="btn btn-primary" onclick="@(() => DebugUnlockAllFollowers())">Unlock Followers</button></p>
    <p><button class="btn btn-primary" onclick="@(() => DebugGetMoney())">Gain Money</button></p>
    <p><button class="btn btn-primary" onclick="@(() => DebugOneOfEveryItem())">Get All Items</button></p>
}

@if ((GameState.saveDataLoaded == false || saveGameExists || gameHasBeenSaved == false) && loadBegun == false)
{
    <p><button class="btn btn-primary" onclick="@(() => LoadData())">Load Game</button></p>
}
else
{
    <p><button class="btn btn-primary" disabled onclick="@(() => LoadData())">Load Game</button></p>
}
@if (saveGameExists == false || (saveGameExists == true && GameState.saveDataLoaded == true))
{
    <p><button class="btn btn-primary" onclick="@(() => SaveData())">Save Game</button></p>
}
else
{
    <p><button class="btn btn-primary" disabled onclick="@(() => SaveData())">Save Game</button></p>
    }

<br />
<br />
@if (userWantsGameReset)
{
    <p><button class="btn btn-primary" onclick="@(() => ResetGame())">Are you sure?</button></p>
}
else
{
    <p><button class="btn btn-primary" onclick="@(() => AskForReset())">Reset Game</button></p>
}

@functions{
    private bool saveGameExists = false;
    private bool loadBegun = false;
    private bool userWantsGameReset = false;
    private bool gameHasBeenSaved = false;
    private bool gameIsRendered = false;
    private bool debugMode = true;

    public void DebugUnlockAllFollowers()
    {
        foreach (Follower f in Program.followerManager.GetFollowers())
        {
            f.IsUnlocked = true;
        }
    }
    public void DebugOneOfEveryItem()
    {

        GameState.GetPlayerBank().GetInventory().AddOneOfMultipleItemsUnlimited(Program.itemDatabase.GetAllItems());

    }
    public void DebugAll99s()
    {
        foreach (Skill s in GameState.GetPlayer().GetSkills())
        {
            GameState.GetPlayer().GainExperience(s.SkillName, 15000000);
        }
    }
    public void DebugGetMoney()
    {
        GameState.GetPlayerBank().GetInventory().AddMultipleOfItemUnlimited(Program.itemDatabase.GetGold(), 100000);
    }
    private void AskForReset()
    {
        userWantsGameReset = true;
    }
    private void ResetGame()
    {
        MessageManager.AddMessage("Save Game Reset. Please reload the page to avoid errors.");
        localStorage.Clear();
        StateHasChanged();
    }
    private string SaveData()
    {
        localStorage.SetItem("Bank", GameState.GetPlayerBank().GetInventory().ToString());
        localStorage.SetItem("Skills", GameState.GetPlayer().GetSkillString());
        localStorage.SetItem("Inventory", GameState.GetPlayerInventory().ToString());
        localStorage.SetItem("Areas", Program.areaManager.SaveAreas());
        localStorage.SetItem("Followers", Program.followerManager.ToString());
        if (GameState.GetPlayer().activeFollower != null)
        {
            localStorage.SetItem("ActiveFollower", GameState.GetPlayer().activeFollower.id);
        }
        List<int> ids = new List<int>();
        foreach (KeyValuePair<GameItem, int> pair in GameState.GetPlayerInventory().GetEquippedItems())
        {
            ids.Add(pair.Key.Id);
        }
        localStorage.SetItem("EquippedItems", ids);
        localStorage.SetItem("AlchemyRecipes", GameState.GetPlayer().GetRecipes());
        localStorage.SetItem("SaveGameExists", true);
        MessageManager.AddMessage("You game has been saved.");
        gameHasBeenSaved = true;
        GameState.saveDataLoaded = true;
        return "";
    }
    private void LoadData()
    {
        loadBegun = true;
        Dictionary<GameItem, int> bankItems = Extensions.GetItemDicFromString(localStorage.GetItem<String>("Bank"), Program.itemDatabase);
        Dictionary<GameItem, int> invItems = Extensions.GetItemDicFromString(localStorage.GetItem<String>("Inventory"), Program.itemDatabase);
        List<Skill> skills = Extensions.GetSkillsFromString(localStorage.GetItem<string>("Skills"));
        List<int> equippedItems = localStorage.GetItem<List<int>>("EquippedItems");
        GameState.GetPlayerBank().GetInventory().LoadItems(bankItems);
        GameState.GetPlayerInventory().LoadItems(invItems);
        GameState.GetPlayer().SetSkills(skills);

        if (equippedItems != null)
        {
            GameState.GetPlayer().EquipItems(equippedItems);
        }

        Program.followerManager.LoadSaveData(localStorage.GetItem<String>("Followers"));

        if (Program.followerManager.GetFollowerByID(localStorage.GetItem<int>("ActiveFollower")).IsUnlocked)
        {
            GameState.GetPlayer().activeFollower = Program.followerManager.GetFollowerByID(localStorage.GetItem<int>("ActiveFollower"));
        }

        GameState.GetPlayer().LoadRecipes(localStorage.GetItem<List<string>>("AlchemyRecipes"));
        Program.areaManager.LoadSaveData(localStorage.GetItem<String>("Areas"));


        MessageManager.AddMessage("Save game loaded.");

        GameState.saveDataLoaded = true;
        GameState.UpdateState();

    }
    protected override void OnInit()
    {
        GameState.StateChanged += OnGameStateChanged;
        if (GameState.gameDataLoaded == false)
        {
            Program.gatherManager.SetGameState(GameState);
            Program.huntingManager.SetGameState(GameState);

            GameState.LoadPlayerData(Http);

            Program.itemDatabase.LoadItems(Http);
            Program.areaManager.LoadAreas(Http);
            Program.buildingManager.LoadBuildings(Http);
            Program.followerManager.LoadFollowers(Http);
            Program.npcManager.LoadNPCs(Http);
            Program.battleManager.LoadMonsters(Http);
            GameState.GetPlayer().SetMessageManager(MessageManager);
            GameState.gameDataLoaded = true;
        }

        saveGameExists = localStorage.GetItem<bool>("SaveGameExists");

        this.StateHasChanged();
    }
    protected override void OnAfterRender()
    {

    }
    void IDisposable.Dispose()
    {
        GameState.StateChanged -= OnGameStateChanged;
    }
    void OnGameStateChanged(object sender, EventArgs e) => StateHasChanged();
}