@page "/SmithingMenu/"
@inject GameState  GameState
@inject MessageManager  MessageManager
@using System.Threading;
@inject Microsoft.AspNetCore.Blazor.Services.WebAssemblyUriHelper UriHelper

<h1>Inside the Smithy</h1>
<p>An entire working forge lays before you. Pick any metal to begin.</p>
@if (GameState.GetPlayer().activeFollower != null && GameState.GetPlayer().activeFollower.AutoCollectSkill == "Smithing")
{
    <p><button onclick="@(() => BeginAutoForging())">Auto Forge</button></p>
}
else
{
    <p><button onclick="@(() => BeginAutoForging())" disabled title="You'll need someone's help to do this.">Auto Forge</button></p>
}

<div class="progress">
    <div class="progress-bar bg-success" style="@GetWidthString();transition:none;" role="progressbar" aria-valuenow=@GetValueString() aria-valuemin="0" aria-valuemax="100"></div>
</div>
<div class="main">
    @LoadActions()
</div>



@functions{


    private bool isAutoForging;
    private bool waitingForAutoCollectMessage = true;
    private GameItem currentSmithingBar;
    private GameItem currentSmithingItem;
    private GameItem autoForgeItem;
    private GameItem autoForgeBar;
    private GameItem autoForgeOre;

    private Timer smithingTimer;
    private Timer autoForgeTimer;

    private int smithingStage = 0;
    private int progress = 0;

    private double speedMulti = 1;

    Random rand = new Random();
    private string areaURL;

    public void BeginAutoForging()
    {
        MessageManager.AddMessage("You enlist " + GameState.GetPlayer().activeFollower.Name + " to help you smith. It's slower going, but you don't have to pay as much attention.");
        foreach (GameItem bar in Program.itemDatabase.GetSmithingBars())
        {
            bool hasIngredients = true;
            if (bar.IngredientIDs != null)
            {

                foreach (int id in bar.IngredientIDs)
                {
                    if (GameState.GetPlayerInventory().HasItem(id))
                    {

                    }
                    else
                    {
                        hasIngredients = false;
                    }
                }
                if (hasIngredients)
                {
                    autoForgeOre = Program.itemDatabase.GetItemByID(bar.IngredientIDs[0]);
                    autoForgeBar = bar;
                    break;
                }
            }
        }
        if(autoForgeBar == null)
        {
            return;
        }
        foreach(GameItem item in Program.itemDatabase.GetSmithingItems())
        {
            if(item.IngredientIDs != null)
            {
                if(item.IngredientIDs[0] == autoForgeBar.Id)
                {
                    autoForgeItem = Program.itemDatabase.GetItemByID(item.Id);
                }
            }
        }
        if(autoForgeItem == null)
        {
            return;
        }
        if(autoForgeTimer != null)
        {
            autoForgeTimer.Dispose();
            autoForgeTimer = null;
        }
        autoForgeTimer = new Timer(new TimerCallback(_ =>
        {

        }), null, 20, 5000);
    }
    public RenderFragment LoadActions()
    {
        return builder =>
        {

            builder.OpenElement(0, "br");
            builder.CloseElement();

            if (GameState.isHunting == false && smithingStage == 0)
            {
                foreach (GameItem i in Program.itemDatabase.GetSmithingBars())
                {

                    builder.OpenElement(0, "button");
                    builder.AddAttribute(0, "class", "btn btn-primary");
                    builder.AddAttribute(0, "style", "margin-bottom:10px");
                    builder.AddAttribute(0, "onclick", () => SetCurrentSmithingBar(i));
                    if (GameState.GetPlayer().HasRequiredLevel(i) == false)
                    {
                        builder.AddAttribute(0, "title", "You lack the levels to smelt this bar.");
                        builder.AddAttribute(0, "disabled", true);
                    }
                    else if (GameState.GetPlayer().HasIngredients(i.IngredientIDs) == false)
                    {
                        builder.AddAttribute(0, "title", "You lack the ingredients to smelt this bar.");
                        builder.AddAttribute(0, "disabled", true);
                    }
                    builder.AddContent(0, i.ItemName);
                    builder.CloseElement();

                    builder.OpenElement(0, "br");
                    builder.CloseElement();


                }

            }
            else if (GameState.isHunting == false && smithingStage == 1 && currentSmithingBar != null)
            {
                builder.OpenElement(0, "button");
                builder.AddAttribute(0, "class", "btn btn-primary");
                builder.AddAttribute(0, "style", "margin-bottom:10px");
                builder.AddAttribute(0, "onclick", () => IncrementSmithingStage());
                if (progress == 0 || progress >= 100)
                {

                }
                else
                {
                    builder.AddAttribute(0, "disabled", true);
                }
                builder.AddContent(0, "Insert " + Extensions.GetIngredientsAsString(currentSmithingBar, Program.itemDatabase) + " into furnace");
                builder.CloseElement();

                builder.OpenElement(0, "br");
                builder.CloseElement();

            }
            else if (GameState.isHunting == false && smithingStage == 2 && currentSmithingBar != null)
            {
                builder.OpenElement(0, "button");
                builder.AddAttribute(0, "class", "btn btn-primary");
                builder.AddAttribute(0, "style", "margin-bottom:10px");
                builder.AddAttribute(0, "onclick", () => IncrementSmithingStage());
                if (progress == 0 || progress >= 100)
                {

                }
                else
                {
                    builder.AddAttribute(0, "disabled", true);
                }
                builder.AddContent(0, "Remove " + currentSmithingBar.ItemName + " from furnace");

                builder.CloseElement();

                builder.OpenElement(0, "br");
                builder.CloseElement();

            }
            else if (GameState.isHunting == false && smithingStage == 3 && currentSmithingBar != null)
            {
                builder.OpenElement(0, "button");
                builder.AddAttribute(0, "class", "btn btn-primary");
                builder.AddAttribute(0, "style", "margin-bottom:10px");

                builder.AddAttribute(0, "onclick", () => ResetSmithingStage());
                if (progress == 0 || progress >= 100)
                {

                }
                else
                {
                    builder.AddAttribute(0, "disabled", true);
                }
                builder.AddContent(0, "Smith another bar");
                builder.CloseElement();
                builder.OpenElement(0, "p");
                builder.AddContent(0, "Hammer " + currentSmithingBar.ItemName + " into a...");
                builder.CloseElement();
                builder.OpenElement(0, "br");
                builder.CloseElement();
                foreach (GameItem i in Program.itemDatabase.GetSmithingItems())
                {
                    if (i.IngredientIDs[0] == currentSmithingBar.Id)
                    {
                        builder.OpenElement(0, "button");
                        builder.AddAttribute(0, "class", "btn btn-primary");
                        builder.AddAttribute(0, "style", "margin-bottom:10px");

                        builder.AddAttribute(0, "onclick", () => SetCurrentSmithingItem(i));
                        if (progress == 0 || progress >= 100)
                        {

                        }
                        else
                        {
                            builder.AddAttribute(0, "disabled", true);
                        }
                        builder.AddContent(0, i.ItemName);
                        builder.CloseElement();

                        builder.OpenElement(0, "br");
                        builder.CloseElement();
                    }
                }


            }
            else if (GameState.isHunting == false && smithingStage == 4 && currentSmithingItem != null)
            {
                builder.OpenElement(0, "button");
                builder.AddAttribute(0, "class", "btn btn-primary");
                builder.AddAttribute(0, "style", "margin-bottom:10px");

                builder.AddAttribute(0, "onclick", () => IncrementSmithingStage());
                if (progress == 0 || progress >= 100)
                {

                }
                else
                {
                    builder.AddAttribute(0, "disabled", true);
                }
                builder.AddContent(0, "Cool " + currentSmithingItem.ItemName + " in water");
                builder.CloseElement();

                builder.OpenElement(0, "br");
                builder.CloseElement();

            }
            else if (GameState.isHunting == false && smithingStage == 5 && currentSmithingItem != null)
            {
                builder.OpenElement(0, "button");
                builder.AddAttribute(0, "class", "btn btn-primary");
                builder.AddAttribute(0, "style", "margin-bottom:10px");

                builder.AddAttribute(0, "onclick", () => CollectItem());
                if (progress == 0 || progress >= 100)
                {

                }
                else
                {
                    builder.AddAttribute(0, "disabled", true);
                }
                builder.AddContent(0, "Withdraw " + currentSmithingItem.ItemName);
                builder.CloseElement();

                builder.OpenElement(0, "br");
                builder.CloseElement();

            }
        };
    }
    private void SetCurrentSmithingBar(GameItem i)
    {
        if(i == null)
        {
            return;
        }
        currentSmithingBar = i;
        GameState.GetPlayerInventory().RemoveItemsByID(i.IngredientIDs);
        smithingStage++;
        StateHasChanged();
        //IncrementSmithingStage();
    }
    private void SetCurrentSmithingItem(GameItem i)
    {
        currentSmithingItem = i;

        GameState.GetPlayerInventory().RemoveItemsByID(i.IngredientIDs);
        IncrementSmithingStage();
    }
    private void IncrementSmithingStage()
    {
        if (smithingTimer != null)
        {
            smithingTimer.Dispose();
        }
        progress = 0;
        SendMessage();

        smithingTimer = new Timer(new TimerCallback(_ =>
        {
            if (progress >= 100)
            {
                if (smithingStage == 2)
                {
                    GameState.GetPlayerInventory().AddItem(currentSmithingBar);
                    GameState.GetPlayer().GainExperience(currentSmithingBar.ExperienceGained);
                }
                smithingTimer.Dispose();
                smithingStage++;
                StateHasChanged();
                GameState.UpdateState();
            }
            progress++;
            StateHasChanged();
            GameState.UpdateState();
        }), null, 20, 20);

        StateHasChanged();
        GameState.UpdateState();
    }
    private void CollectItem()
    {
        smithingStage = 0;
        int numToMake = Math.Max(currentSmithingItem.MadeOnCreation, 1);
        GameState.GetPlayerInventory().AddMultipleOfItem(currentSmithingItem, numToMake);
        GameState.GetPlayer().GainExperience(currentSmithingBar.ExperienceGained);
        currentSmithingItem = null;
        currentSmithingBar = null;
        StateHasChanged();
        GameState.UpdateState();

    }
    private void SendMessage()
    {
        string message = "";
        if (smithingStage == 0)
        {
            message = "You prepare to smelt the ore.";
        }
        else if (smithingStage == 1)
        {
            message = "You place the ore in the furnace.";
        }
        else if (smithingStage == 2)
        {
            message = "You remove the bar from the furnace.";
        }
        else if (smithingStage == 3)
        {
            message = "You hammer the bar into a " + currentSmithingItem.ItemName + ".";
        }
        else if (smithingStage == 4)
        {
            message = "You place the " + currentSmithingItem.ItemName + " in water to cool.";
        }
        else if (smithingStage == 5)
        {
            message = "You withdraw the " + currentSmithingItem.ItemName + " from the water.";
        }
        MessageManager.AddMessage(message);
    }
    private void ResetSmithingStage()
    {
        smithingStage = 0;
    }
    private void SkipToHammerStage()
    {
        smithingStage = 2;
    }
    private string GetWidthString()
    {
        return "width: " + progress + "%";
    }
    private string GetValueString()
    {
        return "" + progress;
    }
    public void AutoCollect()
    {
        int amountTaken = GameState.GetPlayerInventory().RemoveItems(autoForgeItem, GameState.GetPlayer().activeFollower.MaxCarry);
        if(GameState.GetPlayerBank().GetInventory().AddMultipleOfItem(autoForgeOre, amountTaken) == false)
        {
            MessageManager.AddMessage("You have run out of " + autoForgeOre.ItemName + " in your bank.");
        }
        else
        {
            MessageManager.AddMessage(GameState.GetPlayer().activeFollower.AutoCollectMessage.Replace("$", amountTaken.ToString()));
        }

    }

    protected override void OnInit()
    {
        GameState.StateChanged += OnGameStateChanged;
        GameState.canSell = false;
        speedMulti = 1;
        this.StateHasChanged();
        GameState.UpdateState();
    }
    public void Dispose()
    {
        GameState.StateChanged -= OnGameStateChanged;
    }
    void OnGameStateChanged(object sender, EventArgs e) => StateHasChanged();
}